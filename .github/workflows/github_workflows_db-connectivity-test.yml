# GitHub Actions workflow -> DB connectivity test (runs from the repo)
# Triggers: manual dispatch and pushes to feature/fleet-management (adjust branch as needed)
name: DB connectivity test

on:
  workflow_dispatch: {}
  push:
    branches:
      - feature/fleet-management

jobs:
  test-db-connection:
    runs-on: ubuntu-latest
    env:
      # Map repo secrets into environment variables passed to the test script.
      # Preferred: set DB_CONN as a DSN-less connection string in repository secrets.
      DB_CONN: ${{ secrets.DB_CONN }}
      DB_SERVER: ${{ secrets.DB_SERVER }}
      DB_DATABASE: ${{ secrets.DB_DATABASE }}
      DB_USERNAME: ${{ secrets.DB_USERNAME }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_ENCRYPT: ${{ secrets.DB_ENCRYPT }}
      DB_TRUST_SERVER_CERT: ${{ secrets.DB_TRUST_SERVER_CERT }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install system prerequisites (ms ODBC driver)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y curl apt-transport-https gnupg unixodbc-dev build-essential
          # Add Microsoft package repository for msodbcsql (Ubuntu)
          curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
          curl https://packages.microsoft.com/config/ubuntu/22.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
          sudo apt-get update -y
          # Install Microsoft ODBC Driver 18 for SQL Server (adjust if you prefer 17)
          sudo ACCEPT_EULA=Y apt-get install -y msodbcsql18
          # Optional extras sometimes required by pyodbc build (unixODBC already installed)
          sudo apt-get install -y unixodbc unixodbc-dev

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          if [ -f requirements.txt ]; then python -m pip install -r requirements.txt; fi
          # Ensure pyodbc available
          python -m pip install pyodbc

      - name: Run DB connectivity test
        run: |
          python test_db_ci.py
        continue-on-error: false